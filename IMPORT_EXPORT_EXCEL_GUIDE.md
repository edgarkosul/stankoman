# Инструкция для администратора: Импорт/Экспорт товаров в Excel

Этот документ написан для сотрудников, которые не работают с программированием.

## 1. Где находится раздел

В админ-панели есть два пункта:

1. `Импорт/Экспорт товаров`  
   Страница для выгрузки Excel, проверки файла и применения изменений.
2. `История импортов`  
   Страница с журналом всех запусков (что проверяли, что применяли, какие были ошибки).

## 2. Что важно понять до начала

1. Сначала всегда делайте `Проверить файл без применения` (dry-run).
2. Только после успешной проверки нажимайте `Применить последний загруженный Excel`.
3. Кнопка `Применить` применяет **последний** запуск проверки (`dry-run`), а не любой файл в истории.
4. Для безопасности используйте файл, который был выгружен из этой системы, и редактируйте его.
5. Формат файла: только `.xlsx` (Excel).

## 3. Рекомендуемый безопасный сценарий работы

1. Откройте страницу `Импорт/Экспорт товаров`.
2. При необходимости задайте фильтры (категории, только активные, только в наличии).
3. Нажмите `Скачать файл XLSX` и получите текущую выгрузку.
4. Откройте файл в Excel и внесите изменения.
5. Загрузите файл в блоке `Импорт без применения изменений`.
6. Нажмите `Проверить файл без применения`.
7. Посмотрите блок `Результаты последнего dry-run`.
8. Если ошибок и конфликтов нет, нажмите `Применить последний загруженный Excel`.
9. Проверьте результат в `История импортов`.

## 4. Как работают блоки на странице Импорт/Экспорт

## 4.1 Фильтры (экспорт и импорт)

Можно выбрать:

1. Категории.
2. Только активные товары.
3. Только товары в наличии.

Важно:

1. Эти фильтры влияют и на выгрузку, и на импорт.
2. Перед `Применить` оставляйте те же фильтры, что были при `Проверить файл без применения`, чтобы результат не отличался.

## 4.2 Экспорт в Excel

1. Выберите колонки.
2. Нажмите `Скачать файл XLSX`.
3. Система создаст файл и даст кнопку скачивания.

Примечание:

1. Обязательные служебные колонки добавляются автоматически.

## 4.3 Импорт без применения изменений

1. Загрузите `.xlsx`.
2. Нажмите `Проверить файл без применения`.
3. Система НЕ изменяет товары, а только показывает, что произойдет.

## 4.4 Применение импорта

1. Нажмите `Применить последний загруженный Excel` только после проверки.
2. Изменения запишутся в базу.

## 5. Как понимать результаты dry-run

В блоке `Результаты последнего dry-run`:

1. `Создастся` — сколько новых товаров будет создано.
2. `Обновится` — сколько существующих товаров изменится.
3. `Без изменений` — строки, где данные совпадают с текущими.
4. `Конфликтов` — данные устарели (товар уже изменили после выгрузки).
5. `Ошибок` — проблемы в файле, из-за которых строка не может быть обработана.

Ниже показываются детальные таблицы:

1. Какие товары будут созданы.
2. Какие будут обновлены.
3. Какие строки конфликтуют.

## 6. Правила для Excel-файла

1. Используйте `.xlsx`.
2. Первая строка — заголовки колонок.
3. Не удаляйте обязательные колонки:
   - `Наименование`
   - `Изменено`
4. Для переименования товара используйте колонку `Новое наименование`.
5. Не делайте дубли строк с одинаковым наименованием товара в одном файле.

## 7. Важные особенности импорта

1. Сопоставление товара идет по нормализованному имени (`name_normalized`):
   - система игнорирует регистр,
   - лишние пробелы,
   - часть отличий в символах.
2. Для существующих товаров поле `Изменено` должно совпадать с текущим значением в системе, иначе будет конфликт.
3. Новые товары после создания получают безопасные значения:
   - `Показывать на сайте` = выключено,
   - `В наличии` = включено.

То есть новые товары после импорта обычно нужно дополнительно проверить и включить вручную.

## 8. Страница История импортов

Показывает все запуски по товарам.

Основные статусы:

1. `В ожидании` (`pending`)
2. `Проверено` (`dry_run`)
3. `Применено` (`applied`)
4. `Ошибка` (`failed`)

Доступные действия в строке:

1. `Скачать файл` — скачать исходный импортный файл этого запуска.
2. `Показать все проблемы` — открыть список ошибок по строкам.
3. По колонкам `Создастся/Обновится/Конфликтов` можно открыть подробные списки.

## 9. Частые ситуации и что делать

## 9.1 Конфликты > 0

Причина:

1. Товар изменили в системе после вашей выгрузки.

Что делать:

1. Сделайте новую выгрузку.
2. Перенесите правки в новый файл.
3. Повторите проверку и применение.

## 9.2 Ошибки > 0

Причины:

1. Неправильные или неизвестные заголовки колонок.
2. Пустое обязательное `Наименование`.
3. Неверный формат значений в отдельных полях.
4. Конфликт при переименовании (`Новое наименование` уже занято).

Что делать:

1. Откройте `История импортов` -> `Показать все проблемы`.
2. Исправьте файл.
3. Загрузите и проверьте заново.

## 10. Короткий чек-лист перед кнопкой Применить

1. Проверка (`dry-run`) выполнена для нужного файла.
2. `Конфликтов = 0`.
3. `Ошибок = 0`.
4. Фильтры на странице не меняли после проверки.
5. Понимаете, какие строки создаются и обновляются.

Если все пункты выполнены, можно нажимать `Применить последний загруженный Excel`.
